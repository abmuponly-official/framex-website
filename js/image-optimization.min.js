(function(){'use strict';const config={rootMargin:'50px 0px',threshold:0.01,fadeInDuration:300,placeholderClass:'img-placeholder',loadedClass:'img-loaded',errorClass:'img-error',webpSupport:false};const checkWebPSupport=()=>{return new Promise((resolve)=>{const webP=new Image();webP.onload=webP.onerror=()=>{config.webpSupport=webP.height===2;resolve(config.webpSupport);};webP.src='data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA});};const createPlaceholder=(img)=>{const placeholder=document.createElement('div');placeholder.className=config.placeholderClass;const width=img.getAttribute('width');const height=img.getAttribute('height');if(width&&height){placeholder.style.paddingBottom=`${(height/width)*100}%`;}else{placeholder.style.paddingBottom='56.25%';}const placeholderSrc=img.getAttribute('data-placeholder');if(placeholderSrc){placeholder.style.backgroundImage=`url(${placeholderSrc})`;placeholder.style.backgroundSize='cover';placeholder.style.filter='blur(5px)';}else{placeholder.style.backgroundColor='#f0f0f0';}return placeholder;};const loadImage=(img)=>{const src=img.getAttribute('data-src');const srcset=img.getAttribute('data-srcset');const sizes=img.getAttribute('data-sizes');if(!src&&!srcset)return;const tempImg=new Image();tempImg.onload=()=>{if(src)img.src=src;if(srcset)img.srcset=srcset;if(sizes)img.sizes=sizes;img.removeAttribute('data-src');img.removeAttribute('data-srcset');img.removeAttribute('data-sizes');requestAnimationFrame(()=>{img.classList.add(config.loadedClass);const placeholder=img.previousElementSibling;if(placeholder&&placeholder.classList.contains(config.placeholderClass)){setTimeout(()=>{placeholder.remove();},config.fadeInDuration);}});img.dispatchEvent(new CustomEvent('lazyloaded',{detail:{src:src||srcset}}));};tempImg.onerror=()=>{img.classList.add(config.errorClass);const fallback=img.getAttribute('data-fallback');if(fallback&&fallback!==src){img.src=fallback;}img.dispatchEvent(new CustomEvent('lazyerror',{detail:{src:src||srcset}}));};if(srcset)tempImg.srcset=srcset;tempImg.src=src||img.getAttribute('data-src');};let imageObserver;const createObserver=()=>{if(!('IntersectionObserver' in window)){loadAllImages();return;}imageObserver=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;loadImage(img);imageObserver.unobserve(img);}});},{rootMargin:config.rootMargin,threshold:config.threshold});};const processImages=()=>{const lazyImages=document.querySelectorAll('img[data-src],img[data-srcset]');lazyImages.forEach(img=>{if('loading' in HTMLImageElement.prototype){img.loading='lazy';}img.decoding='async';const wrapper=img.parentElement;if(!wrapper.querySelector('.'+config.placeholderClass)){const placeholder=createPlaceholder(img);img.parentElement.insertBefore(placeholder,img);}if(imageObserver){imageObserver.observe(img);}});};const loadAllImages=()=>{const lazyImages=document.querySelectorAll('img[data-src],img[data-srcset]');lazyImages.forEach(loadImage);};const convertToWebP=()=>{if(!config.webpSupport)return;const images=document.querySelectorAll('img[data-src],img[src]');images.forEach(img=>{const src=img.getAttribute('data-src')||img.src;if(src.includes('.webp')||src.startsWith('http://')||src.startsWith('https://')){return;}const webpSrc=src.replace(/\.(jpg|jpeg|png)$/i,'.webp');if(img.getAttribute('data-src')){img.setAttribute('data-src',webpSrc);img.setAttribute('data-fallback',src);}else{img.src=webpSrc;}});};const preloadCriticalImages=()=>{const criticalImages=document.querySelectorAll('img[data-critical]');criticalImages.forEach(img=>{const link=document.createElement('link');link.rel='preload';link.as='image';link.href=img.getAttribute('data-src')||img.src;const srcset=img.getAttribute('data-srcset');if(srcset){link.imageSrcset=srcset;const sizes=img.getAttribute('data-sizes');if(sizes){link.imageSizes=sizes;}}document.head.appendChild(link);loadImage(img);if(imageObserver){imageObserver.unobserve(img);}});};const setupProgressiveLoading=()=>{const progressiveImages=document.querySelectorAll('img[data-progressive]');progressiveImages.forEach(img=>{const lowQuality=img.getAttribute('data-progressive');const highQuality=img.getAttribute('data-src');if(lowQuality&&highQuality){img.src=lowQuality;img.style.filter='blur(5px)';img.style.transition='filter 0.3s';const tempImg=new Image();tempImg.onload=()=>{img.src=highQuality;img.style.filter='none';img.removeAttribute('data-progressive');};tempImg.src=highQuality;}});};window.ImageOptimization={init:async function(){await checkWebPSupport();convertToWebP();createObserver();preloadCriticalImages();setupProgressiveLoading();processImages();if(window.MutationObserver){const observer=new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{if(mutation.addedNodes.length){mutation.addedNodes.forEach((node)=>{if(node.tagName==='IMG'&&(node.getAttribute('data-src')||node.getAttribute('data-srcset'))){processImages();}});}});});observer.observe(document.body,{childList:true,subtree:true});}},load:function(img){if(typeof img==='string'){img=document.querySelector(img);}if(img){loadImage(img);}},loadAll:function(container){if(typeof container==='string'){container=document.querySelector(container);}const images=container?container.querySelectorAll('img[data-src],img[data-srcset]'):[];images.forEach(loadImage);},updateConfig:function(newConfig){Object.assign(config,newConfig);}};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{window.ImageOptimization.init();});}else{window.ImageOptimization.init();}})();